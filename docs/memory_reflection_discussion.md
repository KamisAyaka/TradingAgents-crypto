# 交易系统记忆与反思模块讨论（新版草案）

## 背景

- 只保留交易员记忆，其他角色不再持久化记忆。
- 每一轮交易员输出后生成一条总结，供下一轮自己读取（只读取上一轮与上上一轮）。

## 现状梳理（旧版）

1. **记忆写入时机**
   - 旧方案在 `propagate()` 后写入会话级记忆并做日终聚合。
2. **记忆内容**
   - 旧方案记录“结论/分歧/待办”，交易复盘记录执行与结果。
3. **检索方式**
   - 旧方案按多种记忆类型区分，导致路径复杂。
4. **痛点**
   - 旧方案输出过于重、难以复用。
   - 角色记忆过多，难以聚焦交易员。

## 设计目标（新版）

1. **单角色记忆**：仅交易员持久化记忆，其他节点不写入。
2. **固定读取窗口**：交易员每轮只读取最近 2 条记忆（上一轮与上上一轮）。
3. **轻量 + 可复用**：每轮总结必须短、结构化，能直接指导下一轮决策。
4. **复盘分层**：交易复盘独立于轮次总结，用于真实交易结算后的深度复盘。

## 方案草图（新版）

### 1. 交易员轮次记忆（trader_round_memory）

| 字段           | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| situation      | 本轮关键情境摘要（仅保留辩论结论与价格/仓位关键点）         |
| summary        | 交易员轮次总结（见下方结构）                                 |
| assets         | 资产列表                                                     |
| round_id       | 轮次编号                                                     |
| is_open_entry  | 是否为开仓轮次总结（true/false）                             |
| created_at     | 写入时间                                                     |

交易员轮次总结建议结构（不包含新闻/长文原文）：
```text
[结论] 本轮只做/不做哪个资产 + 方向 + 关键原因
[仓位] 当前持仓变化（新增/减仓/平仓/观望）与原因
[风险] 止损设置与 10% 杠杆亏损约束检查
[下轮关注] 下一轮必须验证的信号/事件
```

### 2. 写入与读取策略

1. **写入**
   - 每轮 Trader 输出后立即生成一条 `trader_round` 总结，写入 SQLite（不进入向量库）。
   - 不再生成会话级记忆。
2. **读取**
   - Trader 每轮只读取最近 2 条 `trader_round` 记录（上一轮与上上一轮）。
   - 若存在未平仓交易，额外读取该交易「开仓时的总结」，并在平仓前的每轮 prompt 中注入，确保持续对齐原始假设与风险边界。
   - 交易员不再读取新闻/长文原文；这些内容仅在辩论阶段消化为结论与信号，并以“总结字段”进入记忆。
3. **交易复盘**
   - 真实交易结算后再触发 `trade_reflection`，写入 `memory_type="trade"`。
   - 该记忆用于跨周期经验沉淀，不参与轮次总结。

### 3. Memory 管理

1. `trader_round` 记忆写入 SQLite；`trade` 复盘仍写入向量库。
2. `trader_round` 只保留最近 N 条（例如 100），旧记录可裁剪。
3. `trade` 记忆长期保留，可按季度/半年做压缩归档。
4. 对于未平仓交易，保留「开仓总结」作为单独记录（建议 `memory_type="open_position_context"`），平仓后可归档或合并进 trade 复盘。

## 未决问题与 TODO（新版）

1. **轮次总结 prompt**：需要写一个专用于 Trader 的“短总结”提示词。
2. **读取策略**：确认是否严格只读 2 条，还是允许按场景扩展（例如亏损后读取更多）。
3. **交易复盘触发**：需要设计开仓/平仓事件的监听或日志回放机制，明确何时调用复盘。
4. **复盘结构**：需要确定 trade_reflection 的结构化字段（执行偏差、假设验证、错误类型标签）。
5. **仓位记录工具**：是否要持续写入历史仓位快照供复盘使用。
6. **开仓总结注入**：需要定义如何在 prompt 中引用开仓总结（模板位置、字数限制）。

## 操作日记（待修改）

1. **移除非交易员记忆**
   - 停止会话级记忆写入与读取。
   - 保留 trade 复盘，新增 trader_round 记忆。
2. **交易员轮次记忆**
   - 每轮生成 `trader_round` 总结并写入 SQLite（不进入向量库）。
   - 交易员每轮只读取最近 2 条 trader_round。
3. **开仓总结注入**
   - 开仓时保存 `open_position_context`。
   - 未平仓期间每轮 prompt 注入开仓总结。
   - 平仓后归档/合并进 trade 复盘。
4. **复盘保存与查询**
   - 平仓后触发 trade_reflection 写入 `memory_type="trade"`。
   - 提供 trade 复盘检索（语义搜索 + metadata 过滤）。
